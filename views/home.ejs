<% if (typeof user !== 'undefined' && user) { %>
    <div class="page-container">
        <div class="page-header">
            <h2>Welcome, <%= user.name %>!</h2>
            <h3>
                <% if (user.role === 'admin') { %>
                    Available Offers (Admin View)
                <% } else { %>
                    Available Carpool Offers
                <% } %>
            </h3>
        </div>

        <% if (user.role !== 'admin') { %>
        <div style="text-align: center; margin-bottom: 2rem;">
            <a href="/carpools/new" class="btn btn-primary">Create a New Offer</a>
        </div>
        <% } %>

        <div class="carpool-grid">
            <% if (carpools && carpools.length > 0) { %>
                <% carpools.forEach(carpool => { %>
                    <div class="carpool-card">
                        <div>
                            <h4><%= carpool.carName %></h4>
                            <p><strong>From:</strong> <%= carpool.location %></p>
                            <p><strong>Time:</strong> <%= carpool.time %></p>
                            <p><strong>Price:</strong> ‚Çπ<%= carpool.price %></p>
                            <p><strong>Seats Available:</strong> <%= (carpool.totalSeats || 0) - (carpool.bookedSeats || 0) %>/<%= carpool.totalSeats %></p>
                            <p><strong>Driver:</strong> <%= (carpool.userId && (carpool.userId.name || carpool.userId)) ? (carpool.userId.name || carpool.userId) : 'Driver' %></p>
                            <p><strong>Contact:</strong> <%= (carpool.userId && carpool.userId.email) ? carpool.userId.email : '' %></p>
                            <p><strong>Preference:</strong> <%= carpool.gender %></p>

                            <% 
                              // normalize owner id
                              const ownerId = carpool.userId && (carpool.userId._id ? carpool.userId._id : carpool.userId);
                              const isOwner = ownerId && String(ownerId) === String(user.id);
                            %>

                            <% if (isOwner && carpool.bookedBy && carpool.bookedBy.length > 0) { %>
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <p><strong>Booked By:</strong></p>
                                    <ul style="list-style: none; padding-left: 1rem;">
                                        <% carpool.bookedBy.forEach(booker => { 
                                            const bookerName = (booker.user && (booker.user.name || booker.user)) ? (booker.user.name || booker.user) : (booker.name || 'User');
                                            const seatsBooked = (booker.seats) ? booker.seats : 1;
                                        %>
                                            <li><%= bookerName %> ‚Äî <%= seatsBooked %> seat<%= (seatsBooked > 1) ? 's' : '' %></li>
                                        <% }) %>
                                    </ul>
                                </div>
                            <% } %>
                        </div>

                        <div class="card-footer">
                            <% if (user.role === 'admin') { %>
                                <form action="/admin/offers/<%= carpool._id %>?_method=DELETE" method="POST">
                                    <button type="submit" class="btn btn-danger">Delete (Admin)</button>
                                </form>
                            <% } else { %>

                                <% 
                                    // compute booking state for current user (defensive)
                                    let userHasBooked = false;
                                    let userBooking = null;
                                    if (carpool.bookedBy && carpool.bookedBy.length > 0) {
                                        for (let i = 0; i < carpool.bookedBy.length; i++) {
                                            const b = carpool.bookedBy[i];
                                            const bookedUserId = b.user ? (b.user._id ? b.user._id : b.user) : (b._id ? b._id : null);
                                            if (bookedUserId && String(bookedUserId) === String(user.id)) {
                                                userHasBooked = true;
                                                userBooking = b;
                                                break;
                                            }
                                        }
                                    }

                                    const ownerId2 = carpool.userId && (carpool.userId._id ? carpool.userId._id : carpool.userId);
                                    const isOwner2 = ownerId2 && String(ownerId2) === String(user.id);

                                    const availableSeats = (carpool.totalSeats || 0) - (carpool.bookedSeats || 0);
                                %>

                                <% if (isOwner2) { %>
                                    <span class="btn" style="background: none; border: 1px solid var(--glow-blue); color: var(--glow-blue); cursor: default;">Your Offer</span>

                                <% } else if (userHasBooked) { %>
                                    <p style="margin:0 0 0.5rem 0;" class="booked-info"><strong>You booked:</strong> <%= userBooking.seats || 1 %> seat<%= ((userBooking.seats && userBooking.seats > 1) ? 's' : '') %></p>
                                    <form action="/carpools/<%= carpool._id %>/cancel" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-danger">Cancel Booking</button>
                                    </form>

                                <% } else if (availableSeats > 0) { %>
                                    <form action="/carpools/<%= carpool._id %>/book" method="POST" class="inline-book-form" style="display:flex; gap:0.5rem; align-items:center;">
                                        <label for="seats-<%= carpool._id %>" class="visually-hidden">Seats</label>
                                        <select id="seats-<%= carpool._id %>" name="seats" required class="seat-select">
                                            <% for (let i = 1; i <= availableSeats; i++) { %>
                                                <option value="<%= i %>"><%= i %> seat<%= (i > 1) ? 's' : '' %></option>
                                            <% } %>
                                        </select>
                                        <button type="submit" class="btn btn-primary">Book</button>
                                    </form>

                                <% } else { %>
                                    <button class="btn" disabled>Fully Booked</button>
                                <% } %>

                            <% } %>

                            <a href="/chat/<%= carpool._id %>" class="btn btn-secondary">Chat</a>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <p style="text-align: center; grid-column: 1 / -1;">No carpool offers available at the moment.</p>
            <% } %>
        </div>
    </div>
<% } else { %>
    <div class="page-container">
        <div class="hero-container">
            <h1 style="font-size: 4.5rem; line-height: 1.2;">University Carpooling,<br>Reimagined.</h1>
            <p style="font-size: 1.2rem; max-width: 550px; margin: 1rem auto 2.5rem;">The smart, affordable, and eco-friendly way for students to commute. Find your ride or offer a seat in just a few clicks.</p>
            <a href="/auth/login-register" class="btn btn-primary" style="padding: 16px 40px; font-size: 1.1rem;">Get Started</a>
        </div>

        <div class="benefits-section">
            <div class="page-header" style="margin-bottom: 3rem;">
                <h2 style="font-size: 2.5rem;">Why PoolUp?</h2>
            </div>
            <div class="carpool-grid">
                <div class="carpool-card">
                    <h4>üí∞ Save Money</h4>
                    <p>Split fuel and toll costs with fellow students. It's the most affordable way to get to and from campus every day.</p>
                </div>
                <div class="carpool-card">
                    <h4>ü§ù Connect & Network</h4>
                    <p>Meet new people from different courses and build your university network. Your next ride could be with your next study partner!</p>
                </div>
                <div class="carpool-card">
                    <h4>üåç Eco-Friendly Travel</h4>
                    <p>Reduce traffic congestion and lower your carbon footprint. Every shared ride helps create a greener campus environment.</p>
                </div>
            </div>
        </div>

        <div class="cta-section">
            <h2>Join Hundreds of Students</h2>
            <p>Ready to make your commute easier, cheaper, and more enjoyable? Sign up in seconds and find your perfect ride today.</p>
            <a href="/auth/login-register" class="btn btn-primary">Sign Up Now</a>
        </div>
    </div>
<% } %>
