<!-- Main page container -->
<div class="page-container" style="display: grid; place-items: center; min-height: 80vh;">
  <div class="page-header" style="margin-bottom: 1rem;">
    <h2>Chat about Ride</h2>
  </div>

  <div class="chat-container">
    <div id="chat-box">
      <% if (messages && messages.length > 0) { %>
        <% messages.forEach(msg => { %>
          <p><strong><%= msg.sender.name %>:</strong> <%= msg.message %></p>
        <% }) %>
      <% } else { %>
        <p style="text-align:center;color:#777">No messages yet. Say hello!</p>
      <% } %>
    </div>

    <form id="chat-form">
      <input type="text" id="message-input" placeholder="Type a message..." required />
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<script>
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const chatBox = document.getElementById('chat-box');

  const carpoolId = "<%= carpoolId %>";
  const userId = "<%= user.id %>";
  const userName = "<%= user.name %>";

  // âœ… FIX 1: HTTPS â†’ WSS
  const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  const ws = new WebSocket(protocol + window.location.host);

  ws.onopen = () => {
    console.log('âœ… WebSocket connected');

    // âœ… FIX 2: Proper join event
    ws.send(JSON.stringify({
      type: 'join',
      carpoolId: carpoolId,
      userId: userId,
      name: userName
    }));
  };

  // âœ… FIX 3: Do NOT check data.type (backend doesn't send it)
  ws.onmessage = (event) => {
    console.log('ðŸ“© Message received:', event.data);

    const data = JSON.parse(event.data);
    const p = document.createElement('p');
    p.innerHTML = `<strong>${data.name}:</strong> ${data.message}`;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  ws.onerror = (err) => {
    console.error('âŒ WebSocket error', err);
  };

  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    ws.send(JSON.stringify({
      type: 'chat',
      carpoolId: carpoolId,
      userId: userId,
      name: userName,
      message: message
    }));

    messageInput.value = '';
  });
</script>
